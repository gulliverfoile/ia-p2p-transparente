# examples/realistic_fractal_node.py
"""
Ejemplo completo: Generar y analizar un nodo fractal realista.
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from src.generators.octet_fractal_v2 import ManufacturingAwareFractalGenerator
from src.simulators.thermal_network_simple import FractalThermalNetwork
import matplotlib.pyplot as plt
import numpy as np

def main():
    print("="*60)
    print("FRACTAL THERMAL CORE - Ejemplo Realista")
    print("="*60)
    
    # 1. GENERAR FRACTAL REALISTA
    print("\n1. Generando nodo fractal con restricciones de fabricación...")
    
    generator = ManufacturingAwareFractalGenerator(
        outer_diameter=2.0,    # mm
        iterations=2,          # 2 iteraciones máximo para fabricación
        min_beam_diameter=0.15,# mm (límite de impresión SLM)
        min_angle=15,          # grados mínimos entre vigas
        target_porosity=0.6
    )
    
    result = generator.generate(export_stl="fractal_node_realistic.stl")
    
    print(f"   Nodos generados: {len(result['points'])}")
    print(f"   Vigas válidas: {len(result['beams'])}")
    print(f"   Porosidad: {result['properties']['porosity']:.3f}")
    print(f"   Área superficial específica: {result['properties']['specific_surface']:.1f} mm²/mm³")
    
    # 2. SIMULAR COMPORTAMIENTO TÉRMICO
    print("\n2. Simulando comportamiento térmico...")
    
    thermal_sim = FractalThermalNetwork(
        nodes=result['points'],
        beams=result['beams'],
        material='aluminum_6061',
        env_temp=293  # 20°C ambiente
    )
    
    # Encontrar nodos extremos para aplicar gradiente
    points = result['points']
    x_coords = points[:, 0]
    
    hot_nodes = np.where(x_coords <= x_coords.min() + 0.1)[0]
    cold_nodes = np.where(x_coords >= x_coords.max() - 0.1)[0]
    
    thermal_result = thermal_sim.solve_steady_state(hot_nodes, cold_nodes)
    
    if thermal_result:
        print(f"   Conductividad efectiva: {thermal_result['effective_conductivity']:.2f} W/m·K")
        print(f"   Flujo de calor total: {thermal_result['total_heat_flow']:.3f} W")
        print(f"   Temperatura máxima: {thermal_result['temperatures'].max():.1f} K")
        print(f"   Temperatura mínima: {thermal_result['temperatures'].min():.1f} K")
    
    # 3. VISUALIZACIÓN
    print("\n3. Generando visualizaciones...")
    
    fig, axes = plt.subplots(1, 3, figsize=(15, 5))
    
    # 3a. Visualización 3D de la estructura
    ax = axes[0]
    ax.set_title("Estructura Fractal")
    ax.set_xlabel("X (mm)")
    ax.set_ylabel("Y (mm)")
    
    for beam in result['beams'][:50]:  # Limitar para claridad
        start, end = beam['start'], beam['end']
        ax.plot([start[0], end[0]], [start[1], end[1]], 
                'b-', alpha=0.6, linewidth=beam['mean_radius']*10)
    
    # 3b. Distribución de temperaturas
    ax = axes[1]
    ax.set_title("Distribución de Temperaturas")
    
    if thermal_result:
        temps = thermal_result['temperatures']
        scatter = ax.scatter(points[:, 0], points[:, 1], 
                           c=temps, cmap='hot', s=20)
        plt.colorbar(scatter, ax=ax, label='Temperatura (K)')
    
    # 3c. Histograma de longitudes de viga
    ax = axes[2]
    ax.set_title("Distribución de Longitudes de Viga")
    
    lengths = [np.linalg.norm(b['end'] - b['start']) for b in result['beams']]
    ax.hist(lengths, bins=20, alpha=0.7, edgecolor='black')
    ax.set_xlabel("Longitud (mm)")
    ax.set_ylabel("Frecuencia")
    
    plt.tight_layout()
    plt.savefig("fractal_analysis.png", dpi=150)
    print("   Visualización guardada como 'fractal_analysis.png'")
    
    # 4. GUARDAR REPORTE
    print("\n4. Generando reporte técnico...")
    
    with open("fractal_node_report.txt", "w") as f:
        f.write("="*60 + "\n")
        f.write("REPORTE TÉCNICO - NODO FRACTAL\n")
        f.write("="*60 + "\n\n")
        
        f.write(f"Parámetros de generación:\n")
        f.write(f"  Diámetro exterior: {generator.R*2} mm\n")
        f.write(f"  Iteraciones: {generator.iterations}\n")
        f.write(f"  Diámetro mínimo de viga: {generator.min_beam} mm\n")
        f.write(f"  Ángulo mínimo entre vigas: {np.rad2deg(generator.min_angle)}°\n\n")
        
        f.write(f"Propiedades geométricas:\n")
        for key, value in result['properties'].items():
            f.write(f"  {key}: {value}\n")
        
        if thermal_result:
            f.write(f"\nPropiedades térmicas:\n")
            f.write(f"  Conductividad efectiva: {thermal_result['effective_conductivity']:.2f} W/m·K\n")
            f.write(f"  Flujo de calor: {thermal_result['total_heat_flow']:.3f} W\n")
            f.write(f"  Rango de temperaturas: {thermal_result['temperatures'].min():.1f} - "
                   f"{thermal_result['temperatures'].max():.1f} K\n")
        
        f.write(f"\nRecomendaciones de fabricación:\n")
        f.write(f"  - Tecnología recomendada: SLM (Selective Laser Melting)\n")
        f.write(f"  - Material: AlSi10Mg o Ti6Al4V\n")
        f.write(f"  - Espesor de capa: 30-50 µm\n")
        f.write(f"  - Post-proceso: Tratamiento térmico a 300°C x 2h\n")
        f.write(f"  - Control de calidad: Micro-CT para verificar porosidad\n")
    
    print("   Reporte guardado como 'fractal_node_report.txt'")
    print("\n" + "="*60)
    print("PROCESO COMPLETADO")
    print("Archivos generados:")
    print("  - fractal_node_realistic.stl (para impresión 3D)")
    print("  - fractal_analysis.png (visualización)")
    print("  - fractal_node_report.txt (reporte técnico)")
    print("="*60)

if __name__ == "__main__":
    main()